## 2018年09月18日

scrapy是一个通用的爬虫框架，但是不支持分布式，
scrapy-redis是为了更方便地实现scrapy分布式爬取，而提供了一些以redis为基础的组件。

添加外键

在表1设置外键表2字段
alter 表1 add constraint 约束名 foreign key(表1_字段) references 表2(表2_字段)

删除的时候要先删除约束名，再删除外键。

redis查看网址：[http://redis.cn](http://redis.cn)

Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制（replication），LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction），事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过 Redis哨兵（Sentinel）和自动 分区（Cluster）提供高可用性（high availability）。 

### string 类型： 512M, 可以是string，数字，图片二进制，存进去的只是一个string对象。

redis-cli

ping  --- pong

设置键值  set key value


设置过期时间：setex key seconds value
存放session过期时间常用


获取值 get key

获取多个值 mget key1  key2

运算加1 incr key   

运算加n incrby key n

追加 append key1  value2

把key对应的value减1   decr key1

把key对应的value减n   decrby key1 n

获取所有键 keys *

支持正则 keys "*1*"

键对应值得类型 type key

删除键及对应的值 del key

设置过期时间，以秒为单位
创建时没有设置过期时间则一直存在，直到使用del删除
expire key seconds

查看有效时间，以秒为单位  ttl key

### hash: 用于存储对象，对象的格式是键值对
name:郭靖
gender:男

hset 键  属性  值

hset key1 name "郭靖"
hset key1 gender "男"

type key1   ---> hset

hget key1

hgetall key1

获取键下所有属性
hkeys key1  

获取属性个数
hlen key1

获取所有的值
hvals key1

### list：列表的元素类型为string 按照插入顺序排序  头或者尾

设置

从头部插入数据
lpush key value [...]

从尾部插入数据
rpush key value [...]

lpush key2 "abc" "ddd"

rpush key3 "qwe" "222"

指定插入 linsert key1 after|before key2 索引 值

linsert key4 after key2 0 "123123"
linsert key4 before key2 0 "234"

取出数据

lpop key2

rpop key3

一个key内操作

rpush mylist "hello"

rpush mylist "world"

linsert mylist before "world" "there"

lrange mylist 0 -1

返回指定索引的值
lindex mylist index

裁剪数据其余的删除
ltrim mylist 开始索引 结束索引

### set： 无序， 元素类型为string, 元素不重复, 集合没有修改操作

添加元素
sadd key m1 [...]

返回所有的元素
smembers key 

删除指定元素
srem key m1

### zset: sorted set 有序集合 元素为string，元素不重复，每个元素都会关联double类型的score,表示权重，通过 权重吧元素从小到大排序， 没有修改操作

增加
zadd key score1 m1 score2 m2 [...]

例1：向键'py31'的集合中添加元素'gj'、'hr'、'yg'、'xln'，权重分别为1、5、8、3

zadd 'py31' 1 'gj' 5 'hr' 8 'yg' 3 'xln'

 获取

返回指定范围内的元素
zrange key start stop

获取键'py31'的集合中所有元素

zrange "py31" 0 -1

返回score值在min和max之间的成员

zrangebyscore key min max

返回成员member的score值
zscore key member 

删除
zrem key m1 m2 [...]

删除权重在指定范围的元素
zremrangebyscore key min max


### python操作redis

#### string-增加
    from redis import *
    
    if __name__ == "__main__":
		try:
     		#创建StrictRedis对象，与redis服务器建立连接
			sr = StrictRedis()
			result = sr.set("py1","value1")
    		#输出响应结果，如果添加成功则返回True，否则返回False
			print(result)
		except Exception as e:
			print(e)

#### string-获取
方法get，添加键对应的值，如果键存在则返回对应的值，如果键不存在则返回None

    #coding=utf-8
    from redis import *

    if __name__=="__main__":
	    try:
	        #创建StrictRedis对象，与redis服务器建立连接
	        sr=StrictRedis()
	        #获取键py1的值
	        result = sr.get('py1')
	        #输出键的值，如果键不存在则返回None
	        print result
	    except Exception as e:
	        print e

#### 获取键
方法keys，根据正则表达式获取键
创建文件redis_keys.py，编写代码如下
    
    #coding=utf-8
    from redis import *
    if __name__=="__main__":
	    try:
	        #创建StrictRedis对象，与redis服务器建立连接
	        sr=StrictRedis()
	        #获取所有的键
	        result=sr.keys()
	        #输出响应结果，所有的键构成一个列表，如果没有键则返回空列表
	        print result
	    except Exception as e:
	        print e

####string-删除
方法delete，删除键及对应的值，如果删除成功则返回受影响的键数，否则则返回0
创建文件redis_delete.py，编写代码如下

    #coding=utf-8
    from redis import *
    if __name__=="__main__":
	    try:
	        #创建StrictRedis对象，与redis服务器建立连接
	        sr=StrictRedis()
	        #设置键py1的值，如果键已经存在则进行修改，如果键不存在则进行添加
	        result = sr.delete('py1')
	        #输出响应结果，如果删除成功则返回受影响的键数，否则则返回0
	        print result
	    except Exception as e:
	        print e

## 2018年09月19日
## 发布订阅（设计模式）
客户端发送到频道的消息，会被推送到所有订阅此频道的客户端，
客户端不需要主动去获取消息，只需要订阅频道，这个频道的内容就会被推送过来

### 消息的格式

推送消息的格式包括三个部分

第一部分： 消息类型 （三类）

    subscribe ， 表示订阅成功
    unsubscribe, 表示取消订阅成功
    message, 表示其他终端发布的消息
如果第一部分的值为subscribe, 则第二部分是频道，第三部分是现在订阅的频道

如果第一部分的值为unsubscribe, 则第二部分是频道，第三部分是现在订阅的顶到数量，如果为0则表示没有当前订阅任何频道，当在pub/sub以外的状态，客户端可以发出任何redis命令

如果第一部分的值为message,则第二部分是来源频道的名称，第三部分是消息的内容。

### 命令
订阅  subscribe 频道名称 【频道名称】

取消订阅

如果不写参数，表示取消订阅

unsubscribe 频道名称 【频道名称】

发布

publish 频道 消息

案例 
	第一个终端
    redis-cli
    # 切换数据库使用  select  数据库名
    select  1
	subscribe  py11    # 现在开始等待消息

	第二个终端
	redis-cli
	subscribe py11

	第三个终端
	redis-cli
	publish py11 "hello"

最终在一二终端显示消息和“hello”

作用：商品剩余个数。通过发布订阅实现，即使更新数据



## 主从配置

虚拟机要把网络适配器设置成桥接模式

一个master可以有多个slave, 一个slave又可以拥有多个slave,如此下去，形成类一个强大的多级服务器集群架构

比如master ip: 192.168.1.99
   slave   ip: 192.168.1.78

设置主服务器的配置

主机修改配置文件
	sudo vi /etc/redis/redis.conf
	
	把bind 127.0.0.1改为
	
	bind 192.168.1.99
	
	退出后
	sudo service redis restart
	
	redis-cli -h 192.168.1.99
	keys *
	
从机修改配置文件
	sudo vi /etc/redis/redis.conf
	
	把bind 127.0.0.1改为
	
	bind 192.168.1.78
	
	slaveof 192.168.1.99 6379
	
	退出后
	sudo service redis restart
	redis-cli -h 192.168.1.78
	keys *

显示效果一样，完成数据的备份。

当自己使用的时候一定要修改redis.conf

## 搭建集群
当前拥有两台主机 192.168.12.107、  192.168.12.84 

连接远端学生电脑 ssh 192.168.12.84

在192.168.12.84上进入Desktop目录，创建redis目录

在redis目录下创建文件7003.conf，编辑内容如下
	
	port 7003
	bind 192.168.12.84
	deamonize yes
	pidfile 7003.pid
	cluster-enabled yes
	cluster-config-file 7003_node.conf
	cluster-node-timeout 15000
	appendonly yes

在redis目录下创建文件7004.conf，编辑内容如下
	
	port 7004
	bind 192.168.12.84
	deamonize yes
	pidfile 7004.pid
	cluster-enabled yes
	cluster-config-file 7004_node.conf
	cluster-node-timeout 15000
	appendonly yes

在redis目录下创建文件7005.conf，编辑内容如下
	
	port 7005
	bind 192.168.12.84
	deamonize yes
	pidfile 7005.pid
	cluster-enabled yes
	cluster-config-file 7005_node.conf
	cluster-node-timeout 15000
	appendonly yes

使用配置文件启动redis服务
redis-server 7003.conf
redis-server 7004.conf
redis-server 7005.conf

可以看到启动成功
192.168.12.84：7003【cluster】
192.168.12.84：7004【cluster】
192.168.12.84：7005【cluster】

#### 创建集群
redis的安装包包含了redis-trib.rb，用于创建集群
接下来的操作在192.168.12.107机器上进行
把命令赋值，这样可以在任何目录下调用此命令

sudo cp /usr/share/doc/redis-tools/example/redis-trib.rb  /usr/local/bin/
### 配置机器1
进入Desktop目录，创建redis目录,
在redis目录下创建文件7000.conf 编辑内容如下
	port 7000
	bind 192.168.12.107
	daemon yes
	pidfile 7000.pid
	cluster-enabled yes
	cluster-config-file 7000_node.conf
	cluster-node-timeout 15000
	appendonly yes
### 配置机器2
进入Desktop目录，创建redis目录,
在redis目录下创建文件7001.conf 编辑内容如下
	port 7000
	bind 192.168.12.107
	daemon yes
	pidfile 7001.pid
	cluster-enabled yes
	cluster-config-file 7001_node.conf
	cluster-node-timeout 15000
	appendonly yes
### 配置机器3
进入Desktop目录，创建redis目录,
在redis目录下创建文件7002.conf 编辑内容如下
	port 7000
	bind 192.168.12.107
	daemon yes
	pidfile 7002.pid
	cluster-enabled yes
	cluster-config-file 7002_node.conf
	cluster-node-timeout 15000
	appendonly yes

总结：三个文件的配置区别在port.pidfile custer-config-file三项

使用配置文件启动redis服务

	redis-server  7000.conf
	redis-server  7001.conf
	redis-server  7002.conf

查看进程

ps ajx | grep redis
显示：
192.168.107：7000【cluster】
192.168.107：7000【cluster】
192.168.107：7000【cluster】

## redis与python交互

第一种方式：r.set
	from redis import *
	r = StrictRedis(host="localhost", port=6379)
	r.set("py10", "hello")

第二种方式：r.pipeline

	from redis import *
	r = StrictRedis(host="localhost", port=6379)
	pipe = r.pipeline()
	pipe.set("py10", "hello")
	pipe.execute()

 
